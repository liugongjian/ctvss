<template>
  <el-form
    ref="videoForm"
    :rules="rules"
    :model="videoForm"
    label-position="right"
    label-width="165px"
  >
    <el-form-item class="full-row" label="接入协议:" :prop="deviceEnum.InVideoProtocol">
      <el-radio
        v-for="(value, key) in inVideoProtocolByDeviceType[deviceForm.deviceType]"
        :key="key"
        v-model="videoForm.inVideoProtocol"
        :label="key"
        :disabled="checkDisable(deviceEnum.InVideoProtocol)"
        @change="inVideoProtocolChange"
      >
        {{ value }}
      </el-radio>
    </el-form-item>
    <el-form-item v-if="checkVisible(deviceEnum.VideoVendor)" label="厂商:" :prop="deviceEnum.VideoVendor">
      <el-select v-model="videoForm.videoVendor">
        <el-option
          v-for="(value, key) in deviceVendor[videoForm.inVideoProtocol]"
          :key="key"
          :label="value"
          :value="key"
        />
      </el-select>
    </el-form-item>
    <el-form-item v-if="checkVisible(deviceEnum.InVersion)" label="版本:" :prop="deviceEnum.InVersion">
      <el-radio-group v-model="videoForm.inVersion">
        <el-radio-button
          v-for="(value, key) in versionByInVideoProtocol[videoForm.inVideoProtocol]"
          :key="key"
          :label="value"
          :value="key"
          :disabled="checkDisable(deviceEnum.InVersion)"
        />
      </el-radio-group>
    </el-form-item>
    <el-form-item v-if="checkVisible(deviceEnum.DeviceChannelSize)" label="子设备数量:" :prop="deviceEnum.DeviceChannelSize">
      <el-input-number
        v-model="videoForm.deviceChannelSize"
        :min="minChannelSize"
        type="number"
      />
    </el-form-item>
    <el-form-item v-if="checkVisible(deviceEnum.InUserName)" label="GB28181账号:" :prop="deviceEnum.InUserName">
      <certificate-select v-model="videoForm.inUserName" :disabled="checkDisable(deviceEnum.InUserName)" :type="inVideoProtocolEnum.Gb28181" />
    </el-form-item>
    <el-form-item v-if="checkVisible(deviceEnum.InType)" label="视频流接入方式:" :prop="deviceEnum.InType">
      <!-- <el-radio
        v-for="(value, key) in inType"
        :key="key"
        v-model="videoForm.inType"
        :label="key"
      >
        {{ value }}
      </el-radio> -->
      <!-- Temp Commit -->
      <el-radio v-model="videoForm.inType" label="push" :disabled="videoForm.inVideoProtocol === 'rtsp'">推流</el-radio>
      <el-radio v-model="videoForm.inType" label="pull" :disabled="videoForm.inVideoProtocol === 'rtmp'">拉流</el-radio>
    </el-form-item>
    <template v-if="videoForm[deviceEnum.VideoVendor] === '其他' || checkVisible(deviceEnum.OnlyPullUrl)">
      <el-form-item v-if="checkVisible(deviceEnum.PullUrl)" label="拉流地址:" :prop="deviceEnum.PullUrl">
        <el-input v-model="videoForm.pullUrl" />
      </el-form-item>
    </template>
    <template v-else>
      <el-form-item v-if="checkVisible(deviceEnum.UserName)" label="用户名:" :prop="deviceEnum.UserName">
        <el-input v-model="videoForm.userName" />
      </el-form-item>
      <el-form-item v-if="checkVisible(deviceEnum.Password)" label="密码:" :prop="deviceEnum.Password">
        <el-input v-model="videoForm.password" type="password" />
      </el-form-item>
      <el-form-item v-if="checkVisible(deviceEnum.EnableDomain)" label="是否启用域名:" :prop="deviceEnum.EnableDomain">
        <el-switch
          v-model="videoForm.enableDomain"
          :active-value="1"
          :inactive-value="2"
        />
      </el-form-item>
      <el-form-item v-if="checkVisible(deviceEnum.DeviceDomain)" label="设备域名:" :prop="deviceEnum.DeviceDomain">
        <el-input v-model="videoForm.deviceDomain" />
      </el-form-item>
      <el-form-item v-if="checkVisible(deviceEnum.Ip)" label="接入IP:" :prop="deviceEnum.DeviceIp">
        <el-input v-model="videoForm.deviceIp" />
      </el-form-item>
      <el-form-item v-if="checkVisible(deviceEnum.Port)" label="端口:" :prop="deviceEnum.DevicePort">
        <el-input v-model="videoForm.devicePort" />
      </el-form-item>
    </template>
    <el-form-item v-if="checkVisible(deviceEnum.DeviceStreamSize)" label="主子码流数量:" :prop="deviceEnum.DeviceStreamSize">
      <template slot="label">
        主子码流数量:
        <el-popover
          placement="top-start"
          title="主子码流数量"
          width="400"
          trigger="hover"
          :open-delay="300"
        >
          <div>
            单码流: 仅有一种码流<br>双码流: 主、子码流<br>三码流:
            主、子、第三码流
          </div>
          <svg-icon slot="reference" class="form-question" name="help" />
        </el-popover>
      </template>
      <el-radio
        v-for="(value, key) in deviceStreamSize"
        :key="key"
        v-model="videoForm.deviceStreamSize"
        :label="+key"
        :disabled="deviceForm.deviceType === deviceTypeEnum.Nvr && +key === 3 "
        @change="onDeviceStreamSizeChange"
      >
        {{ value }}
      </el-radio>
    </el-form-item>
    <el-form-item v-if="checkVisible(deviceEnum.DeviceStreamAutoPull)" :prop="deviceEnum.DeviceStreamAutoPull">
      <template slot="label">
        自动拉流:
        <el-popover
          placement="top-start"
          title="自动拉流"
          width="400"
          trigger="hover"
          :open-delay="300"
          :content="tips.deviceStreamAutoPull"
        >
          <svg-icon slot="reference" class="form-question" name="help" />
        </el-popover>
      </template>
      <el-switch
        v-model="videoForm.deviceStreamAutoPull"
        :active-value="1"
        :inactive-value="2"
        :disabled="checkDisable(deviceEnum.DeviceStreamAutoPull)"
      />
    </el-form-item>
    <el-form-item
      v-if="checkVisible(deviceEnum.DeviceStreamPullIndex)"
      label="自动拉取码流:"
      :prop="deviceEnum.DeviceStreamPullIndex"
    >
      <el-radio
        v-for="(value, key) in deviceStreamPullIndex"
        :key="key"
        v-model="videoForm.deviceStreamPullIndex"
        :label="+key"
        :disabled="+key > videoForm.deviceStreamSize"
      >
        {{ value }}
      </el-radio>
    </el-form-item>
    <el-form-item v-if="checkVisible(deviceEnum.PushType)" :prop="deviceEnum.PushType">
      <template slot="label">
        自动激活推流地址:
        <el-popover
          placement="top-start"
          title="自动激活推流地址"
          width="400"
          trigger="hover"
          :open-delay="300"
          :content="tips.pushType"
        >
          <svg-icon slot="reference" class="form-question" name="help" />
        </el-popover>
      </template>
      <el-switch
        v-model="videoForm[deviceEnum.PushType]"
        :active-value="1"
        :inactive-value="2"
      />
    </el-form-item>
    <el-form-item v-if="checkVisible(deviceEnum.StreamTransProtocol)" :prop="deviceEnum.StreamTransProtocol">
      <template slot="label">
        优先TCP传输:
        <el-popover
          placement="top-start"
          title="优先TCP传输"
          width="400"
          trigger="hover"
          :open-delay="300"
          :content="tips.streamTransProtocol"
        >
          <svg-icon slot="reference" class="form-question" name="help" />
        </el-popover>
      </template>
      <el-switch
        v-model="videoForm.streamTransProtocol"
        active-value="tcp"
        inactive-value="udp"
        :disabled="checkDisable(deviceEnum.StreamTransProtocol)"
      />
    </el-form-item>
    <el-form-item v-if="checkVisible(deviceEnum.OutId)" label="自定义国标ID:" :prop="deviceEnum.OutId">
      <el-input v-model="videoForm.outId" />
      <div v-if="!isEdit" class="form-tip">
        用户可自行录入规范国标ID，未录入该项，平台会自动生成规范国标ID。
      </div>
    </el-form-item>
    <el-form-item v-if="checkVisible(deviceEnum.Resource)" class="full-row" label="配置资源包:" :prop="deviceEnum.Resource">
      <resource ref="resourceForm" v-model="videoForm.resource" :device-id="deviceId" @loaded="$emit('loaded')" />
    </el-form-item>
    <div v-show="showMoreVisable" class="show-more" :class="{ 'show-more--expanded': showMore }">
      <el-form-item>
        <el-button class="show-more--btn" type="text" @click="showMore = !showMore">更多<i class="el-icon-arrow-down" /></el-button>
      </el-form-item>
      <div ref="showMoreForm" class="show-more--form">
        <el-form-item v-if="checkVisible(deviceEnum.Tags)" label="视频标签:" :prop="deviceEnum.Tags">
          <tags v-model="videoForm.tags" class="tags" />
        </el-form-item>
      </div>
    </div>
  </el-form>
</template>

<script lang="ts">
import { Component, Prop, Watch, Vue } from 'vue-property-decorator'
import { DeviceEnum, InTypeEnum, InVideoProtocolEnum, DeviceTypeEnum, InNetworkTypeEnum } from '@vss/device/enums/index'
import { InVideoProtocolModelMapping, InVideoProtocolByDeviceType, DeviceVendor, InType, DeviceStreamSize, DeviceStreamPullIndex, VersionByInVideoProtocol } from '@vss/device/dicts'
import { Device, DeviceBasic, VideoDevice, DeviceBasicForm, VideoDeviceForm } from '@vss/device/type/Device'
import { DeviceTips } from '@vss/device/dicts/tips'
import { validGbId } from '@vss/device/api/device'
import { checkVideoVisible, checkFormDisable } from '@vss/device/utils/param'
import CertificateSelect from '@vss/device/components/CertificateSelect.vue'
import Tags from '@vss/device/components/Tags.vue'
import Resource from '@vss/device/components/Resource/index.vue'

@Component({
  name: 'VideoCreateForm',
  components: {
    CertificateSelect,
    Tags,
    Resource
  }
})
export default class extends Vue {
  @Prop() private device: Device
  @Prop({ default: {} }) private deviceForm: DeviceBasicForm
  @Prop({ default: false }) private isIbox: boolean
  @Prop({ default: false }) private isEdit: boolean
  public videoForm: VideoDeviceForm = {}
  private deviceEnum = DeviceEnum
  private deviceTypeEnum = DeviceTypeEnum
  private inVideoProtocolEnum = InVideoProtocolEnum
  private inNetworkTypeEnum = InNetworkTypeEnum
  private tips = DeviceTips
  private deviceVendor = DeviceVendor
  private inVideoProtocolByDeviceType = InVideoProtocolByDeviceType
  private inType = InType
  private deviceStreamSize = DeviceStreamSize
  private deviceStreamPullIndex = DeviceStreamPullIndex
  private versionByInVideoProtocol = VersionByInVideoProtocol
  private showMore = false
  private showMoreVisable = false
  private minChannelSize = 1
  private rules = {
    [DeviceEnum.InVideoProtocol]: [
      { required: true, message: '请选择接入协议', trigger: 'change' }
    ],
    [DeviceEnum.VideoVendor]: [
      { required: true, message: '请选择厂商', trigger: 'change' }
    ],
    [DeviceEnum.DeviceChannelSize]: [
      { required: true, message: '请填写子设备数量', trigger: 'blur' }
    ],
    [DeviceEnum.InUserName]: [
      { required: true, message: '请选择账号', trigger: 'change' }
    ],
    [DeviceEnum.PullUrl]: [
      { required: true, message: '请输入自定义设备拉流地址', trigger: 'blur' }
    ],
    [DeviceEnum.UserName]: [
      { required: true, message: '请输入用户名', trigger: 'blur' }
    ],
    [DeviceEnum.Password]: [
      { required: true, message: '请输入密码', trigger: 'blur' }
    ],
    [DeviceEnum.DeviceDomain]: [
      { required: true, message: '请输入设备域名', trigger: 'blur' },
      { validator: this.validateDeviceDomain, trigger: 'blur' }
    ],
    [DeviceEnum.DeviceIp]: [
      { required: true, message: '请输入设备IP', trigger: 'blur' },
      { validator: this.validateDeviceIp, trigger: 'blur' }
    ],
    [DeviceEnum.DevicePort]: [
      { required: true, message: '请输入设备端口', trigger: 'blur' },
      { validator: this.validateDevicePort, trigger: 'change' }
    ],
    [DeviceEnum.Resource]: [
      { validator: this.validateResource, trigger: 'change' }
    ],
    [DeviceEnum.OutId]: [
      { validator: this.validateGbId, trigger: 'blur' }
    ]
  }

  // 设备基本信息
  private get basicInfo(): DeviceBasic {
    return (this.device && this.device.device) || {} as DeviceBasic
  }

  // 设备ID
  private get deviceId() {
    return this.basicInfo && this.basicInfo.deviceId
  }

  // 设备通道数量初始值
  private get orginalChannelSize() {
    return this.basicInfo && this.basicInfo.deviceChannelSize
  }

  // 视频接入协议
  private get inVideoProtocol() {
    return this.device && this.device.videos && this.device.videos.length && this.device.videos[0].inVideoProtocol
  }

  // 视频接入信息
  private get videoInfo(): VideoDevice {
    return (this.inVideoProtocol && this.device.videos[0][InVideoProtocolModelMapping[this.inVideoProtocol]]) || {} as VideoDevice
  }

  @Watch('device', {
    immediate: true
  })
  private onDeviceChange() {
    this.videoForm = {
      [DeviceEnum.InVideoProtocol]: this.inVideoProtocol || InVideoProtocolEnum.Gb28181,
      [DeviceEnum.VideoVendor]: this.basicInfo.deviceVendor,
      [DeviceEnum.InVersion]: this.videoInfo.inVersion || '2016',
      [DeviceEnum.DeviceChannelSize]: this.basicInfo.deviceChannelSize || 1,
      [DeviceEnum.InUserName]: this.videoInfo.inUserName,
      [DeviceEnum.InType]: this.videoInfo.inType || InTypeEnum.Pull,
      [DeviceEnum.PullUrl]: this.videoInfo.pullUrl,
      [DeviceEnum.UserName]: this.videoInfo.userName,
      [DeviceEnum.Password]: this.videoInfo.password,
      [DeviceEnum.EnableDomain]: this.videoInfo.enableDomain || 2,
      [DeviceEnum.DeviceDomain]: this.videoInfo.deviceDomain,
      [DeviceEnum.DeviceIp]: this.videoInfo.deviceIp,
      [DeviceEnum.DevicePort]: this.videoInfo.devicePort,
      [DeviceEnum.DeviceStreamSize]: this.videoInfo.deviceStreamSize || 1,
      [DeviceEnum.DeviceStreamAutoPull]: this.videoInfo.deviceStreamAutoPull || 1,
      [DeviceEnum.DeviceStreamPullIndex]: this.videoInfo.deviceStreamPullIndex || 1,
      [DeviceEnum.PushType]: this.videoInfo.pushType || 1,
      [DeviceEnum.StreamTransProtocol]: this.videoInfo.streamTransProtocol || 'tcp',
      [DeviceEnum.OutId]: this.videoInfo.outId,
      [DeviceEnum.Tags]: this.videoInfo.tags,
      [DeviceEnum.Resource]: { resourceIds: [], aIApps: [] }
    }
  }

  /**
   * 设备类型变化
   */
  @Watch('deviceForm.deviceType')
  private deviceTypeChange() {
    this.videoForm.inVideoProtocol = InVideoProtocolEnum.Gb28181
  }

  private updated() {
    this.checkIsShwoMore()
  }

  /**
   * 校验video表单
   */
  public validateVideoForm() {
    const videoForm: any = this.$refs.videoForm
    return new Promise((resolve) => {
      videoForm.validate((valid) => {
        resolve(valid)
      })
    })
  }

  /**
   * 判断是否显示更多下拉框
   */
  private checkIsShwoMore() {
    const showMoreForm = this.$refs.showMoreForm as HTMLDivElement
    this.showMoreVisable = showMoreForm.children.length !== 0
  }

  /**
   * 视频接入协议变化
   */
  private inVideoProtocolChange(val) {
    this.$emit('inVideoProtocolChange', val)
    // 重置vendor
    this.videoForm.videoVendor = ''
    // 重置version
    const versionMap = VersionByInVideoProtocol[this.videoForm.inVideoProtocol]
    versionMap && (this.videoForm.inVersion = Object.values(versionMap)[0] as string)
    // Temp Commit
    if (this.videoForm.inVideoProtocol === InVideoProtocolEnum.Rtmp) {
      this.videoForm.inType = 'push'
    }

    if (this.videoForm.inVideoProtocol === InVideoProtocolEnum.Rtsp) {
      this.videoForm.inType = 'pull'
    }
  }

  /**
   * 码流数变化回调
   */
  private onDeviceStreamSizeChange() {
    if (this.videoForm.deviceStreamSize < this.videoForm.deviceStreamPullIndex) {
      this.videoForm.deviceStreamPullIndex = this.videoForm.deviceStreamSize
    }
  }

  /**
   * 当资源包改变时获取资源包详情（包含接入剩余设备数）
   */
  private onResourceChange(payload: any) {
    this.resourcesMapping = payload.mapping
    const videoForm: any = this.$refs.videoForm
    !payload.isInit && videoForm.validateField(DeviceEnum.Resources)
  }

  /**
   * 判断是否显示form-item
   */
  private checkVisible(prop) {
    return checkVideoVisible.call(this.videoForm, this.deviceForm.deviceType, this.videoForm.inVideoProtocol, prop, { isIbox: this.isIbox, isEdit: this.isEdit })
  }

  /**
   * 判断表单项是否可以编辑
   */
  private checkDisable(prop) {
    return this.basicInfo && checkFormDisable.call(this.basicInfo, prop, { isEdit: this.isEdit })
  }

  /**
   * 编辑状态时生成提示信息
   */
  public beforeSubmit(submit: Function) {
    const resourceForm = this.$refs.resourceForm as Resource
    resourceForm.beforeSubmit(submit, this.basicInfo.deviceChannelSize, this.orginalChannelSize)
  }

  /*
   * 校验设备Domain格式
   */
  public validateDeviceDomain(rule: any, value: string, callback: Function) {
    if (value && !/^[a-zA-Z0-9][-a-zA-Z0-9]{0,62}(\.[a-zA-Z0-9][-a-zA-Z0-9]{0,62})+\.?$/.test(value)) {
      callback(new Error('设备域名格式不正确。正确域名格式例如: www.domain.com'))
    } else {
      callback()
    }
  }

  /**
   * 校验资源包
   */
  public validateResource(rule: any, value: string, callback: Function) {
    const resourceForm = this.$refs.resourceForm as Resource
    const res = resourceForm.validate(this.videoForm.deviceChannelSize, this.orginalChannelSize)
    if (!res.result) {
      callback(new Error(res.message))
    } else {
      callback()
    }
  }

  /**
   * 校验设备IP格式
   */
  public validateDeviceIp(rule: any, value: string, callback: Function) {
    if (value && !/^((2[0-4]\d|25[0-5]|[01]?\d\d?)\.){3}(2[0-4]\d|25[0-5]|[01]?\d\d?)$/.test(value)) {
      callback(new Error('设备IP格式不正确'))
    } else {
      callback()
    }
  }

  /**
   * 校验端口号
   */
  public validateDevicePort(rule: any, value: string, callback: Function) {
    if (value && !/^[0-9]+$/.test(value)) {
      callback(new Error('设备端口仅支持数字'))
    } else {
      callback()
    }
  }

  /**
   * 校验设备国标ID
   */
  public async validateGbId(rule: any, value: string, callback: Function) {
    let validInfo: any
    if (value && !/^[0-9]{20}$/.test(value)) {
      callback(new Error('请输入规范国标ID'))
    } else if (value) {
      try {
        validInfo = await validGbId({
          [DeviceEnum.DeviceId]: this.deviceId,
          [DeviceEnum.InVideoProtocol]: this.videoForm.inVideoProtocol,
          // [DeviceEnum.OutId]: this.videoForm.outId
          gbId: this.videoForm.outId
        })
        console.log(validInfo)
        if (validInfo && !validInfo.isValidGbId) {
          callback(new Error('存在重复国标ID'))
        } else {
          callback()
        }
      } catch (e) {
        console.log(e)
      }
    } else {
      callback()
    }
  }
}
</script>
